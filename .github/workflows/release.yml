name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.artifact }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            goarch: amd64
            artifact: valvefm-linux-amd64
          - os: ubuntu-24.04-arm
            goarch: arm64
            artifact: valvefm-linux-arm64
          - os: macos-latest
            goarch: arm64
            artifact: valvefm-macos-arm64
          - os: macos-latest
            goarch: amd64
            artifact: valvefm-macos-amd64
          - os: windows-latest
            goarch: amd64
            artifact: valvefm-windows-amd64.exe

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"

      - name: Install Linux tray deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libgtk-3-dev libayatana-appindicator3-dev libasound2-dev

      - name: Build
        shell: bash
        env:
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist
          go build -trimpath -ldflags="-s -w" -o dist/${{ matrix.artifact }} ./cmd/radio-tray

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}
          if-no-files-found: error
          retention-days: 1

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    outputs:
      checksums: ${{ steps.sums.outputs.checksums }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Checksums
        id: sums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt
          echo "checksums<<EOF" >> "$GITHUB_OUTPUT"
          cat checksums.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Upload release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.ref_name }} dist/* --clobber -R ${{ github.repository }}

  update-homebrew:
    name: Update Homebrew
    runs-on: ubuntu-latest
    needs: release
    env:
      VERSION: ${{ github.ref_name }}

    steps:
      - uses: actions/checkout@v4
        with:
          repository: zorig/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update formula
        env:
          CHECKSUMS: ${{ needs.release.outputs.checksums }}
        run: |
          VER="${VERSION#v}"
          MAC_ARM_SHA=$(echo "$CHECKSUMS" | grep valvefm-macos-arm64 | cut -d' ' -f1)
          MAC_AMD_SHA=$(echo "$CHECKSUMS" | grep valvefm-macos-amd64 | cut -d' ' -f1)
          LINUX_ARM_SHA=$(echo "$CHECKSUMS" | grep valvefm-linux-arm64 | cut -d' ' -f1)
          LINUX_AMD_SHA=$(echo "$CHECKSUMS" | grep valvefm-linux-amd64 | cut -d' ' -f1)

          cat > Formula/valvefm.rb << EOF
          class Valvefm < Formula
            desc "Terminal radio tuner with a vintage dial interface"
            homepage "https://github.com/zorig/valvefm"
            version "${VER}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/zorig/valvefm/releases/download/v#{version}/valvefm-macos-arm64"
                sha256 "${MAC_ARM_SHA}"
              end
              on_intel do
                url "https://github.com/zorig/valvefm/releases/download/v#{version}/valvefm-macos-amd64"
                sha256 "${MAC_AMD_SHA}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/zorig/valvefm/releases/download/v#{version}/valvefm-linux-arm64"
                sha256 "${LINUX_ARM_SHA}"
              end
              on_intel do
                url "https://github.com/zorig/valvefm/releases/download/v#{version}/valvefm-linux-amd64"
                sha256 "${LINUX_AMD_SHA}"
              end
            end

            def install
              bin.install Dir["valvefm-*"].first => "valvefm"
            end

            test do
              assert_predicate bin/"valvefm", :executable?
            end
          end
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/valvefm.rb
          git commit -m "valvefm ${VERSION}"
          git push

  update-chocolatey:
    name: Update Chocolatey
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Build and push package
        env:
          VERSION: ${{ github.ref_name }}
          CHECKSUMS: ${{ needs.release.outputs.checksums }}
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          VER="${VERSION#v}"
          WIN_SHA=$(echo "$CHECKSUMS" | grep valvefm-windows-amd64 | cut -d' ' -f1)
          URL="https://github.com/zorig/valvefm/releases/download/v${VER}/valvefm-windows-amd64.exe"

          mkdir -p pkg/tools pkg/_rels

          cat > pkg/valvefm.nuspec << NUSPEC
          <?xml version="1.0" encoding="utf-8"?>
          <package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
            <metadata>
              <id>valvefm</id>
              <version>${VER}</version>
              <title>Valve FM</title>
              <authors>zorig</authors>
              <projectUrl>https://github.com/zorig/valvefm</projectUrl>
              <licenseUrl>https://github.com/zorig/valvefm/blob/main/LICENSE</licenseUrl>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <description>Vintage FM radio TUI for streaming stations from radio-browser.info.</description>
              <tags>radio tui terminal fm streaming</tags>
            </metadata>
          </package>
          NUSPEC

          cat > pkg/tools/chocolateyInstall.ps1 << INSTALL
          \$ErrorActionPreference = 'Stop'
          \$toolsDir = Split-Path -Parent \$MyInvocation.MyCommand.Definition
          Get-ChocolateyWebFile -PackageName 'valvefm' \`
            -FileFullPath "\$toolsDir\valvefm.exe" \`
            -Url64bit '${URL}' \`
            -Checksum64 '${WIN_SHA}' \`
            -ChecksumType64 'sha256'
          INSTALL

          cat > 'pkg/[Content_Types].xml' << 'CT'
          <?xml version="1.0" encoding="utf-8"?>
          <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
            <Default Extension="nuspec" ContentType="application/octet" />
            <Default Extension="ps1" ContentType="application/octet" />
            <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml" />
          </Types>
          CT

          cat > pkg/_rels/.rels << 'RELS'
          <?xml version="1.0" encoding="utf-8"?>
          <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
            <Relationship Type="http://schemas.microsoft.com/packaging/2010/07/manifest" Target="/valvefm.nuspec" Id="R1" />
          </Relationships>
          RELS

          cd pkg
          zip -qr ../valvefm.${VER}.nupkg .
          cd ..

          dotnet nuget push "valvefm.${VER}.nupkg" \
            --source "https://push.chocolatey.org/" \
            --api-key "${CHOCO_API_KEY}"
